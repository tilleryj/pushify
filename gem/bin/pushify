#!/usr/bin/env ruby
require 'rubygems'
require 'daemons'
require 'juggernaut'

lib_dir = File.join(File.dirname(__FILE__), "..", "lib")
require File.join(lib_dir, "pushify", "install")
require File.join(lib_dir, "pushify", "server")


Pushify::Install.install! if ARGV.include?('install')


# TODO: HACK
pids = File.join('tmp', 'pids')
pid = File.join(pids, 'juggernaut.pid')
if ARGV.include?('stop')
  system("kill #{File.read(pid)}")
  system("rm #{pid}")
else
  config = File.exist?("config/juggernaut.yml") ? "config/juggernaut.yml" : File.join(File.dirname(__FILE__), "..", "install", "juggernaut.yml")
  system("juggernaut -c#{config} -d -P #{pid}")
end

Daemons.run_proc(File.join(pids, 'pushify_server.rb')) { Pushify::Server.run }
